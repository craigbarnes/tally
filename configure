#!/bin/sh

abort() {
    echo "Error: $1" >&2
    exit 1
}

version_min() {
    test -n "$1" -a -n "$2" || abort "version_min called with too few arguments"
    printf "$1\n$2" | sort -t. -n -k1,1 -k2,2 -k3,3 -k4,4 | head -n1
}

RAGEL=$(command -v ragel || abort "Unable to find 'ragel' command")
GPERF=$(command -v gperf || abort "Unable to find 'gperf' command")

GPERF_V=$(gperf -v | sed -n '1{s/^GNU gperf \([0-9.]\+\).*/\1/p}')
test -n "$GPERF_V" || abort "Unable to parse gperf version string"

if test $(version_min "$GPERF_V" 3.1) != 3.1; then
    echo "Found gperf $GPERF_V: overriding length type to 'unsigned'" >&2
    CPPFLAGS='CPPFLAGS += -DLENGTH_TYPE=unsigned'
fi

cat > config.mk << EOF
RAGEL = $RAGEL
GPERF = $GPERF
GPERF_VERSION = $GPERF_V
$CPPFLAGS
EOF
